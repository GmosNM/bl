#private

f1 :: fn (list: *string) {
    defer strings.append(list, "B");    
    strings.append(list, "A");    
}

f2 :: fn (list: *string) {
    defer strings.append(list, "D");    
    defer strings.append(list, "C");
    defer strings.append(list, "B");
    strings.append(list, "A");    
}

f3 :: fn (list: *string) {
    defer strings.append(list, "G");    
    defer strings.append(list, "F");
    defer strings.append(list, "E");
    strings.append(list, "A");    
    {
        defer strings.append(list, "C");        
        defer strings.append(list, "B");        
    }
    strings.append(list, "D");    
}

f4 :: fn (list: *string) {
    defer strings.append(list, "H");    
    defer strings.append(list, "G");
    defer strings.append(list, "F");
    
    fn (list: *string) {
        defer strings.append(list, "B");            
        defer strings.append(list, "A");            
    } (list);
    {
        defer strings.append(list, "D");        
        defer strings.append(list, "C");        
    }
    strings.append(list, "E");    
}

defer_test :: fn () #test {
    list :: strings.new();
    defer strings.delete(list);
    
    f1(&list);
    test_eq(list, "AB");
    strings.clear(&list);
    
    f2(&list);
    test_eq(list, "ABCD");
    strings.clear(&list);
    
    f3(&list);
    test_eq(list, "ABCDEFG");
    strings.clear(&list);

    f4(&list);
    test_eq(list, "ABCDEFGH");
    strings.clear(&list);
}